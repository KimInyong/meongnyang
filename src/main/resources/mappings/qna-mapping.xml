<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="qnaDAO">
	
	<select id="selectInfoQna" parameterType="qna" resultType="qna">
		SELECT 
			customer.customer_tb_no, customer.customer_tb_name, customer.customer_tb_email
		FROM 
			customer, qna
		WHERE 
			customer.customer_tb_no = qna.customer_tb_no and rownum = 1
	</select>


	<!-- 전체 글수 -->
	<select id="selectCountQna" resultType="int">
		SELECT COUNT(*) FROM qna
	</select>
	<!-- 게시글 조회수 증가 -->
	<update id="updateReadcount" parameterType="int">
		UPDATE 
			qna
		SET
			qna_tb_readcount = qna_tb_readcount + 1
		WHERE qna_tb_no = #{qnaTbNo}
	</update>
	
	<insert id="insertNewQna" parameterType="qna">
		INSERT INTO qna
			(qna_tb_no, pd_sale_tb_no, qna_type_tb_no, customer_tb_no, qna_tb_title,
			qna_tb_content, qna_tb_reg_date, qna_tb_secret, qna_tb_ref)
		VALUES
			(qna_seq.nextval, #{pdSaleTbNo}, #{qnaTypeTbNo}, #{customerTbNo}, #{qnaTbTitle},
			#{qnaTbContent}, sysdate, #{qnaTbSecret}, qna_seq.nextval)
		
	</insert>
	
	<!-- 답변글 -->
	<insert id="insertQna" parameterType="qna">
		INSERT INTO qna
			(qna_tb_no, pd_sale_tb_no, qna_type_tb_no, customer_tb_no, qna_tb_title,
			qna_tb_content, qna_tb_reg_date, qna_tb_secret, qna_tb_ref)
		VALUES
			(qna_seq.nextval, #{pdSaleTbNo}, #{qnaTypeTbNo}, #{customerTbNo}, #{qnaTbTitle},
			#{qnaTbContent}, sysdate, #{qnaTbSecret}, #{qnaTbRef})
		
	</insert>
	<update id="updateStep" parameterType="qna">
		UPDATE
			qna
		SET
			qna_tb_step = qna_tb_step + 1
		WHERE
			qna_tb_ref = #{qnaTbRef} AND qna_tb_step > #{qnaTbStep}	
	</update>
	<update id="updateStepDepth" parameterType="qna">
		UPDATE
			qna
		SET
			qna_tb_step = qna_tb_step + 1,
			qna_tb_depth = qna_tb_depth +1  
		WHERE 
			qna_tb_no = 
			(SELECT
				c.qna_tb_no
			FROM
				(SELECT
					ROWNUM RNUM,
					b.qna_tb_no
				FROM
				(SELECT
					A.qna_tb_no
				FROM qna a
				WHERE qna_tb_ref = #{qnaTbRef} AND qna_tb_step = #{qnaTbStep}
				ORDER BY qna_tb_no) b ) c 
				WHERE c.rnum = 2)
	
	</update>
	
	
	<select id="clientSelectQna" parameterType="qna" resultType="qna">
		SELECT
			qna_tb_no,
			pd_sale_tb_no,
			qna_type_tb_no,
			customer_tb_no,
			qna_tb_title,
			qna_tb_content,
			qna_tb_reg_date,
			qna_tb_readcount,
			qna_tb_secret,
			qna_tb_ref,
			qna_tb_step,
			qna_tb_depth,
			qna_tb_status,
			pd_order_tb_no
		FROM 
			qna
		WHERE 
			qna_tb_no = #{qnaTbNo}
	</select>
	
	<select id="selectQnaList" resultType="qna" parameterType="qna">
		
		SELECT 
			*
		FROM
			(SELECT
				ROWNUM rnum,
				qna_tb_no,
				pd_sale_tb_no,
				qna_type_tb_no,
				customer_tb_no,
				qna_tb_title,
				qna_tb_content,
				qna_tb_reg_date,
				qna_tb_readcount,
				qna_tb_secret,
				qna_tb_ref,
				qna_tb_step,
				qna_tb_depth,
				qna_tb_status,
				pd_order_tb_no
			FROM (SELECT 
						*
					FROM
						qna
					ORDER BY 
						qna_tb_ref DESC, qna_tb_step ASC))
			
			 <![CDATA[WHERE rnum >= #{startRow} AND rnum <= #{endRow}]]>  
	</select>
	<select id="adminSelectQnaList" resultType="qna" parameterType="qna">
		
		SELECT 
			*
		FROM
			(SELECT
				ROWNUM rnum,
				qna_tb_no,
				pd_sale_tb_no,
				qna_type_tb_no,
				customer_tb_no,
				qna_tb_title,
				qna_tb_content,
				qna_tb_reg_date,
				qna_tb_readcount,
				qna_tb_secret,
				qna_tb_ref,
				qna_tb_step,
				qna_tb_depth,
				qna_tb_status,
				pd_order_tb_no
				
			FROM (SELECT 
						*
					FROM
						qna
					ORDER BY 
						qna_tb_ref DESC, qna_tb_step ASC))
			
			   
	</select>
	

	<update id="updateQna" parameterType="qna">
		UPDATE qna
		SET
			qna_tb_title = #{qnaTbTitle},
			qna_tb_content = #{qnaTbContent},
			
		WHERE 
			qna_tb_no = #{qnaTbNo}
	</update>
	<delete id="deleteQna" parameterType="qna">
		UPDATE qna
		SET
			qna_tb_status = #{qnaTbStatus}
		WHERE 
			qna_tb_no = #{qnaTbNo}
	</delete>
	
	<select id="selectQna" parameterType="qna" resultType="qna">
		SELECT
			qna_tb_no,
			pd_sale_tb_no,
			qna_type_tb_no,
			customer_tb_no,
			qna_tb_title,
			qna_tb_content,
			qna_tb_reg_date,
			qna_tb_readcount,
			qna_tb_secret,
			qna_tb_ref,
			qna_tb_step,
			qna_tb_depth,
			qna_tb_status,
			pd_order_tb_no
		FROM
			qna
		WHERE 
			qna_tb_no = #{qnaTbNo}
	</select>
</mapper>
